CREATE TABLE  `bads7105-308204.supermarket.customer_month` AS

    SELECT SHOP_YEAR,
        SHOP_YM,
        SHOP_MONTH_LD,
        LAST_SHOP_YM,
        CUST_CODE,
        CUST_PRICE_SENSITIVITY,
        CUST_LIFESTAGE,
        COUNT(DISTINCT BASKET_ID ) AS ORDER_PER_MONTH,
        SUM(TOTAL_SPEND) AS SPENDING_PER_MONTH,
        ROW_NUMBER() OVER (PARTITION BY CUST_CODE ORDER BY SHOP_YM) AS ROW_NO

    FROM (
        SELECT *,
            EXTRACT(MONTH FROM SHOP_DATE) as SHOP_MONTH,
            LAST_DAY(SHOP_DATE,MONTH) AS SHOP_MONTH_LD,
        # EXTRACT(QUARTER FROM SHOP_DATE) as SHOP_QUARTER,
            EXTRACT(YEAR FROM SHOP_DATE) as SHOP_YEAR,
            FORMAT_DATE("%Y%m", SHOP_DATE) AS SHOP_YM,
            #EXTRACT(YEAR FROM SHOP_DATE) || "Q" || EXTRACT(QUARTER FROM SHOP_DATE) as SHOP_YQ,
            FORMAT_DATE("%Y%m", DATE_ADD(SHOP_DATE, INTERVAL -1 MONTH)) as LAST_SHOP_YM
        FROM (
                SELECT CAST(BASKET_ID AS STRING) AS BASKET_ID,
                CUST_CODE,
                CUST_PRICE_SENSITIVITY,
                CUST_LIFESTAGE,
                PARSE_DATE("%Y%m%d",CAST (SHOP_DATE AS STRING)) AS SHOP_DATE,
                SUM(SPEND) AS TOTAL_SPEND
                FROM `bads7105-308204.supermarket.supermarket`
                WHERE CUST_CODE IS NOT NULL
                GROUP BY BASKET_ID,CUST_CODE,CUST_PRICE_SENSITIVITY,CUST_LIFESTAGE,SHOP_DATE
                ))
        GROUP BY SHOP_YEAR,
        SHOP_YM,
        SHOP_MONTH_LD,
        LAST_SHOP_YM,
        CUST_CODE,
        CUST_PRICE_SENSITIVITY,
        CUST_LIFESTAGE

        ORDER BY CUST_CODE,SHOP_YM




CREATE TABLE  `bads7105-308204.supermarket.month` AS

WITH MONTH AS (
SELECT SHOP_YEAR,
SHOP_YM,
SHOP_MONTH_LD,
LAST_SHOP_YM,
COUNT(DISTINCT CUST_CODE) AS ACTIVE_CUSTOMER,
SUM(ORDER_PER_MONTH) AS TOTAL_ORDER,
SUM(SPENDING_PER_MONTH) AS TOTAL_REVENUE,
AVG(SPENDING_PER_MONTH) AS ARPU
FROM `bads7105-308204.supermarket.customer_month`
GROUP BY SHOP_YEAR,
SHOP_YM,
SHOP_MONTH_LD,
LAST_SHOP_YM)

SELECT T1.*,
T2.ACTIVE_CUSTOMER AS LAST_ACTIVE_CUSTOMER,
T2.TOTAL_ORDER AS LAST_TOTAL_ORDER,
T2.TOTAL_REVENUE AS LAST_TOTAL_REVENUE,
T2.ARPU AS LAST_ARPU,
(T1.ACTIVE_CUSTOMER - T2.ACTIVE_CUSTOMER)/T2.ACTIVE_CUSTOMER AS CHURN_RATE,
(T1.TOTAL_REVENUE * (1/((T1.ACTIVE_CUSTOMER - T2.ACTIVE_CUSTOMER)/T2.ACTIVE_CUSTOMER))/T1.ACTIVE_CUSTOMER) AS CLV
FROM MONTH AS T1 
LEFT JOIN MONTH AS T2
ON T1.LAST_SHOP_YM = T2.SHOP_YM